<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:8.0pt;
	margin-left:0cm;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
a:link, span.MsoHyperlink
	{color:#0563C1;
	text-decoration:underline;}
.MsoChpDefault
	{font-family:"Calibri",sans-serif;}
.MsoPapDefault
	{margin-bottom:8.0pt;
	line-height:107%;}
@page WordSection1
	{size:595.3pt 841.9pt;
	margin:72.0pt 72.0pt 72.0pt 72.0pt;}
div.WordSection1
	{page:WordSection1;}
-->
</style>

</head>

<body lang=en-FI link="#0563C1" vlink="#954F72">

<div class=WordSection1>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US
style='font-size:16.0pt;line-height:107%'>CinCan Malware Analysis – Workshop and
My Own Findings</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>The purpose of
this report is to describe what I learned during the workshop by Kimmo Linnavuo
on the <a href="https://cincan.io/">CinCan<br>
malware analysis tool</a> after the fact, what I think about the tool - and to
demonstrate that knowledge on a sample <br>
that I found on the internet.<br>
This report was written for the Penetration Testing course taught by <a
href="http://terokarvinen.com/2020/tunkeutumistestaus-kurssi-pentest-course-ict4tn027-3003/">Tero
Karvinen</a>.</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US
style='font-size:16.0pt;color:black'>Kimmo Linnavuo's Workshop</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>The workshop was a hit and miss, Mr. Linnavuo
was great at answering questions we asked<br>
and clearing things that we did not understand. But unfortunately, the
structure of the workshop<br>
was lacking and a lot of the students felt like being out of the loop.<br>
<br>
The workshop started with Mr. Linnavuo explaining who he is, and what is CinCan.<br>
CinCan is a tool developed with the cooperation of many universities that is aimed
for use in<br>
malware analysis.<br>
After this Mr. Linnavuo decided to demonstrate the tool in action on some .eml
files, to show us<br>
how to find malicious emails. We did this by using the <a
href="https://cincan.io/tools/eml_parser/">cincan/eml_parser</a> tool to see
all the headers<br>
return addresses and contents of the messages, while piping them to output
files in order to read them<br>
at any moment. We also used a tool called <a
href="https://cincan.io/tools/headless-thunderbird/">headless-thunderbird</a>
in order to make images of what the emails<br>
would look like to the recipient. <br>
This is unfortunately all that I remember from that part of the workshop, except
the fact that the return-address<br>
is the real address of the sender, and that the address can be spoofed for the
recipient in order to look like a trusted<br>
source.<br>
<br>
Then we moved on to analyzing a memory-dump from a computer that for the
workshop was made to look like it was<br>
owned by a malicious actor, trying to spread a malware by email. This part of
the workshop was the most unclear,<br>
and Mr. Linnavuo went way too fast with the analysis, outputting and proceeded
to do this with little to no explaination.<br>
From what I remember, the contents of the memory dump were extracted into
separate .img files, some containing emails<br>
and the like, based on what processes were still in the computers memory during
the extraction. These files were further analyzed<br>
with evidence linking the owner of the computer to the creation and attempted
spread of the malware. The result looked very<br>
impressive, but due to the speed at which we went through it I did not manage
to follow well at all.<br>
<br>
Lastly we went over the analysis of a malicious .apk  (andoid application),
which was rated as the easiest &quot;challenge&quot; of all three.<br>
We used <a href="https://cincan.io/tools/dex2jar/">dex2jar</a> to split the .apk
into parts inside a folder, including a classes-dex2jar.jar file, which we
analyzed with another tool.<br>
Inside we found a hardcoded password that is used to decrypt all the files on
the phone, along with the file formats the ransomware<br>
encrypts. We also took a look at the encryption method and the URI that is used
to get and send data to.<br>
<br>
At the end of the workshop we had a short Q&amp;A and were encouraged to tell
our opinion about the tool.</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US
style='font-size:16.0pt;color:black'>My Findings</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>I decided to get my own sample to analyze. And
try my best to find and understand the payloads<br>
executed during the runtime of the virus.<br>
I used cincan/ghidra-decompiler for this and downloaded the clean MEMZ.exe and .bat
for analysis.<br>
This means that this version of the version can be safely tested without it
writing to the boot sector<br>
and destroying the users computer (although it should still be run in a VM).<br>
The demonstration of the virus in full capabality can be found <a
href="https://www.youtube.com/watch?v=I-jdSgjtUPk">here.</a><br>
While the demonstration for the clean version can be found <a
href="https://www.youtube.com/watch?v=C19JfFKAogE">here.</a></span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>First, I started out by seeing the list of
commands for ghidra-decompiler along with reading the <a
href="https://cincan.io/tools/ghidra-decompiler/">cincan documentation</a>:</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><img
border=0 width=609 height=310 id="Picture 2"
src="cincan-malware-analysis_files/image001.png"></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>Then I unzipped the MEMZ virus zip-file and ran
the ghidra-decompiler, but the thing that is not shown here is that<br>
I ultimately piped the output to a memz.c file:</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=736
height=545 id="Picture 1" src="cincan-malware-analysis_files/image002.png"></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>The first lines
of the decompiled code:</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=495
height=652 id="Picture 3" src="cincan-malware-analysis_files/image003.png"></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>As we can see, the
tool already found some <a
href="http://www.cplusplus.com/doc/tutorial/structures/">variable data structures</a>,
which actually may not that look<br>
important at first glance. But turns out, the writer of this malware heavily
relied on the<br>
<a
href="https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptacquirecontextw">Win32
API</a>, due to the variables like KEYBDINPUT, MOUSEINPUT, along with others
that are in this<br>
.exe.</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=422
height=348 id="Picture 4" src="cincan-malware-analysis_files/image004.png"></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>Some Ghidra
autogenerated comments that I find neat.</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=746
height=667 id="Picture 5" src="cincan-malware-analysis_files/image005.png"></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=707
height=321 id="Picture 7" src="cincan-malware-analysis_files/image006.png"></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>Code from the MEMZ
4.0 control panel.</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=589
height=485 id="Picture 8" src="cincan-malware-analysis_files/image007.png"></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>This is the
payload that draws icons on the screen.</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US
style='color:black'>Now I noticed that a certain function was being called in
the code very often,<br>
</span><span lang=EN-US>FUN_00401b58, so I decided to take a look at it:</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=714
height=220 id="Picture 9" src="cincan-malware-analysis_files/image008.png"></p>

<p class=MsoNormal style='margin-left:36.0pt'><i><span lang=EN-US>&amp;DAT_00404220
= returns an exact memory address / pointer at specific memory address. </span></i></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>The pointer,
which is probably &amp;HCryptProv, a handle to the CSP (Cryptographic Service
Provider), is passed to <a
href="https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptacquirecontextw">CryptAcquireContextW</a>,<br>
at least, according to the aforementioned documentation. We can also see it's
paremeters, szContainer and szProvider <br>
which are both set to null. Then, the provider type is set to 1 with the flag
values set to 0xf00000040, which is a hexadecimal <br>
representation of the flag. If no CSP is found, then the process is killed, else
the function generates four random bytes with the CSP <br>
provided and assigning them to the unsigned integer local_8.<br>
Then the program returns the variable with 0x7fffffff &quot;anded&quot; to it,
which means that the random value get randomized even more.<br>
<br>
What I get from this, is that this is the random() function from win32 api,
that was not written by the writer of the virus,<br>
but instead heavily relied on by him/her.</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=549
height=867 id="Picture 10" src="cincan-malware-analysis_files/image009.png"></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=720
height=312 id="Picture 11" src="cincan-malware-analysis_files/image010.png"></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>The payload that
opens google searches, the list of the searches is probably assembled from the
base64 data<br>
that gets compiled from the MEMZ-Clean.bat file:<br>
</span><img border=0 width=794 height=857 id="Picture 19"
src="cincan-malware-analysis_files/image011.png"></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>I have tried
stripping off the base64 data and read it, but it is non-human readable.</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=605
height=342 id="Picture 12" src="cincan-malware-analysis_files/image012.png"></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>The payload that
makes the mouse shake.</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=538
height=267 id="Picture 13" src="cincan-malware-analysis_files/image013.png"></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>Function that
plays random windows sounds (PlaySoundA)</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=714
height=256 id="Picture 14" src="cincan-malware-analysis_files/image014.png"></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>Payload that
reverses the colors of all the windows. I figured this due to the BitBlt
function, that sets the colors of windows.</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=616
height=252 id="Picture 15" src="cincan-malware-analysis_files/image015.png"></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>The payload that
grabs a string and reverses it by calling the function FUN_004701ba3:</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=542
height=552 id="Picture 16" src="cincan-malware-analysis_files/image016.png"></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><img border=0 width=655
height=335 id="Picture 17" src="cincan-malware-analysis_files/image017.png"><span
lang=EN-US><br>
The payload that creates the tunnel effect, I came to this conclusion due to
the StretchBlt function.</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>A big thank you
to <a href="https://github.com/hvislyset">Kyle McDonald from University of
Western Australia</a> for helping me with understanding this malware<br>
and digging through the Ghidra / Win32 API documentation with me to find the function
calls in this malware.</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US
style='font-size:16.0pt;line-height:107%'>My thoughts on CinCan</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>I think CinCan
is a collection of tools with great potential. Although the documentation on it
is lacking at the moment,<br>
it is understandable due to the project being in early stages and I think it is
a great privilege that Tero Karvinen<br>
arranged for this opportunity for us.<br>
I think that with time, this tool could become a standard in incident response,
along with other analytical fields<br>
and can make history. I loved how easy it is to use this toolset, although the
syntax for it has not been determined<br>
yet and requires reading the documentation for each tool to find out it's
syntax. <br>
Even at this stage of the project I do recommend this toolset to at least
support standard analysis of malicious items<br>
in professional areas, along with the use to learn the analysis of malicious
items.<br>
Hopefully in the future the syntax inconsistency is going to be fixed, along
with additions to the documentation.<br>
Another thing I would love to see in the future, is some sort of open tutorial
for all users with samples like we had<br>
in the workshop anyone could get and analyze.</span></p>

<p class=MsoNormal style='margin-left:36.0pt;line-height:11.55pt'><span
lang=EN-US style='color:black'>-------------------------------------</span></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>This concludes
my report on the CinCan workshop. I feel like this report was lacking due to my
lack of knowledge on the topic<br>
and I hope I can revisit this report in the future and clear up the parts of
this that I did not describe as well as I wish I could.<br>
<br>
<a href="index.html">Return to Main page</a></span></p>

<p class=MsoNormal style='margin-left:36.0pt'><span lang=EN-US>&nbsp;</span></p>

</div>

</body>

</html>
